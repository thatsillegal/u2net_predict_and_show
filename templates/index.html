<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>图像处理 - U2Net</title>
    <style>
        #example-images img {
            max-width: 100px;
            margin: 5px;
            cursor: pointer;
            border: 2px solid transparent;
        }
        #example-images img.selected {
            border-color: blue;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.min.js"></script>
</head>
<body>
    <h2>上传一张图片，获取预测 Mask</h2>
    <a style="color: red"> 尽量使用正方形清晰卫星图像 </a>
    <form id="upload-form" enctype="multipart/form-data">
        <input type="file" name="image" id="imageInput" accept="image/*" required />
        <button type="submit">上传并处理</button>
    </form>

    <h3>示例图片（点击使用）：</h3>
    <div id="example-images">
        <!-- 示例图放这里，src换成你的图片路径 -->
        <img src="/static/examples/example1.png" alt="示例1" data-src="/static/examples/example1.png">
        <img src="/static/examples/example2.png" alt="示例2" data-src="/static/examples/example2.png">
        <img src="/static/examples/example3.png" alt="示例3" data-src="/static/examples/example3.png">
    </div>

    <h3>原图：</h3>
    <img id="originalImage" style="max-width: 400px;"><br>

    <h3>处理结果：</h3>
    <img id="resultImage" style="max-width: 400px;"><br>

    <h3>3D 模型展示：</h3>
    <div id="three-container" style="width: 600px; height: 400px;"></div>


    <script>
        const exampleImages = document.querySelectorAll('#example-images img');
        let selectedExample = null;

        // 选择示例图触发
        exampleImages.forEach(img => {
            img.addEventListener('click', () => {
                // 取消之前选中样式
                if (selectedExample) selectedExample.classList.remove('selected');
                // 设置当前选中样式
                img.classList.add('selected');
                selectedExample = img;

                // 加载示例图到原图展示
                const imgUrl = img.getAttribute('data-src');
                document.getElementById('originalImage').src = imgUrl;

                // 发送示例图给后端
                fetch(imgUrl)
                .then(response => response.blob())
                .then(blob => {
                    const formData = new FormData();
                    formData.append('image', blob, 'example.jpg');

                    return fetch('/process', {
                        method: 'POST',
                        body: formData
                    });
                })
                .then(res => res.json())
                .then(data => {
                    //
                    if (data.image) {
                        document.getElementById('resultImage').src = data.image;
                        console.log("已设置图片");
                    } else {
                        console.warn("返回值中没有 image 字段！", data);
                    }
                    // 轮廓数据是二维点集数组
                    const contours = data.contours;
                    // 清空场景
                    scene.children
                        .filter(obj => !["ground", "mainLight", "ambientLight"].includes(obj.name))
                        .forEach(obj => scene.remove(obj));
                    // 可以传给 Three.js 生成几何体（举例拉伸模型）
                    contours.forEach(polygon => {
                        const shape = new THREE.Shape();
                        polygon.forEach(([x, y], index) => {
                            if (index === 0) {
                                shape.moveTo(x, y);
                            } else {
                                shape.lineTo(x, y);
                            }
                        });
                        const geometry = new THREE.ExtrudeGeometry(shape, { depth: 10, bevelEnabled: false });
                        // 支持光照与阴影的材质
                        const material = new THREE.MeshStandardMaterial({
                            color: 0xFFF9C4,
                            roughness: 0.6,
                            metalness: 0.2
                        });

                        const mesh = new THREE.Mesh(geometry, material);
                        mesh.castShadow = true; // 启用投射阴影
                        scene.add(mesh);
                    });
                })
                .catch(err => {
                    alert('处理出错: ' + err);
                });
            });
        });

        // 上传表单提交处理
        document.getElementById('upload-form').addEventListener('submit', function (e) {
            e.preventDefault();

            const fileInput = document.getElementById('imageInput');
            const file = fileInput.files[0];
            if (!file) return;

            // 取消示例图选中
            if (selectedExample) {
                selectedExample.classList.remove('selected');
                selectedExample = null;
            }

            const formData = new FormData();
            formData.append('image', file);

            // 显示原图
            const reader = new FileReader();
            reader.onload = function (e) {
                document.getElementById('originalImage').src = e.target.result;
            };
            reader.readAsDataURL(file);

            // console.log("122")
            // 发送到 Flask 后端
            fetch('/process', {
                method: 'POST',
                body: formData
            })
            .then(res => {
                if(!res.ok)
                {
                    throw new Error("HTTP 错误状态码：" + res.status);
                }
                return res.json()
                })
            .then(data => {
                //
                if (data.image) {
                    document.getElementById('resultImage').src = data.image;
                    console.log("已设置图片");
                    // console.log(data.image)
                } else {
                    console.warn("返回值中没有 image 字段！", data);
                }
                // 轮廓数据是二维点集数组
                const contours = data.contours;
                // 清空场景
                scene.children
                    .filter(obj => !["ground", "mainLight", "ambientLight"].includes(obj.name))
                    .forEach(obj => scene.remove(obj));
                // 可以传给 Three.js 生成几何体（举例拉伸模型）
                contours.forEach(polygon => {
                    const shape = new THREE.Shape();
                    polygon.forEach(([x, y], index) => {
                        if (index === 0) {
                            shape.moveTo(x, y);
                        } else {
                            shape.lineTo(x, y);
                        }
                    });
                    const geometry = new THREE.ExtrudeGeometry(shape, { depth: 10, bevelEnabled: false });
                    // 支持光照与阴影的材质
                    const material = new THREE.MeshStandardMaterial({
                        color: 0xFFF9C4,
                        roughness: 0.6,
                        metalness: 0.2
                    });

                    const mesh = new THREE.Mesh(geometry, material);
                    mesh.castShadow = true; // 启用投射阴影
                    scene.add(mesh);
                });
                //
            })
            .catch(err => {
                alert('处理出错: ' + err);
                console.error("Fetch 报错：", err); // 一定要加这句！
            });
        });

        let angle = 0;
        const radius = 400;
        const center = new THREE.Vector3(250, 250, 0);

        // 创建基本场景
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf0f0f0);

        const camera = new THREE.PerspectiveCamera(75, 600 / 400, 0.1, 1000);
        camera.position.x = 0;
        camera.position.y = 0;
        camera.position.z = 150;
        camera.lookAt(center);

        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(600, 400);
        document.getElementById('three-container').appendChild(renderer.domElement);

        // 创建一个大平面作为地面（XY 平面）
        const planeSize = 1000;
        const geometry = new THREE.PlaneGeometry(planeSize, planeSize);
        const material = new THREE.MeshBasicMaterial({ color: 0xcccccc, side: THREE.DoubleSide });
        const ground = new THREE.Mesh(geometry, material);
        ground.name = "ground";

        // 旋转平面，使其位于 XY 平面（默认是 XZ 平面）
        // ground.rotation.x = Math.PI / 2; // 绕 X 轴旋转 90 度，把 Z 改为 Y
        scene.add(ground)

        // 渲染器开启阴影
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;

        // 添加方向光用于投射阴影
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
        directionalLight.name = "mainLight";
        directionalLight.position.set(100, 100, 200);
        directionalLight.castShadow = true;
        scene.add(directionalLight);

        // 添加环境光柔和整体亮度
        ambientLight = new THREE.AmbientLight(0xffffff, 0.4)
        ambientLight.name = "ambientLight";
        scene.add(ambientLight);


        // 设置阴影分辨率（更清晰）
        directionalLight.shadow.mapSize.width = 2048;
        directionalLight.shadow.mapSize.height = 2048;
        directionalLight.shadow.camera.near = 1;
        directionalLight.shadow.camera.far = 1000;
        directionalLight.shadow.camera.left = -300;
        directionalLight.shadow.camera.right = 300;
        directionalLight.shadow.camera.top = 300;
        directionalLight.shadow.camera.bottom = -300;

        // 设置地面接收阴影
        ground.receiveShadow = true;

        // 动画循环
        function animate() {
            requestAnimationFrame(animate);
            // scene.add(ground);
            angle += 0.01; // 旋转角度递增

            // 计算相机新的位置（绕Y轴）
            camera.position.x = center.x + radius * Math.cos(angle);
            camera.position.y = center.y + radius * Math.sin(angle);
            camera.position.z = 150; // 保持一个高度

            camera.up.set(0, 0, 1);   // Z轴作为“上”方向
            camera.lookAt(center); // 相机始终看向物体中心

            renderer.render(scene, camera);
        }
        animate();
    </script>  
</body>
</html>
